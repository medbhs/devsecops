name: DevSecOps

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write   # To upload SARIF
  actions: read

jobs:
  precommit:
    name: Pre-commit (format, lint, secrets)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements-dev.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install pre-commit

      - name: Run pre-commit on all files
        run: pre-commit run --all-files

  static:
    name: Static Analysis (Bandit, mypy, pip-audit)
    runs-on: ubuntu-latest
    needs: precommit
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -r requirements.txt

      - name: Bandit (SARIF)
        run: |
          bandit -r . -x tests -f sarif -o bandit.sarif || true

      - name: Upload Bandit SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit.sarif

      - name: mypy (type check)
        run: |
          mypy .

      - name: pip-audit (requirements*.txt â†’ SARIF)
        run: |
          pip-audit -r requirements.txt -f sarif -o pip-audit.sarif || true
          if [ -f requirements-dev.txt ]; then pip-audit -r requirements-dev.txt -f sarif -o pip-audit-dev.sarif || true; fi

      - name: Upload pip-audit SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif

      - name: Upload pip-audit-dev SARIF (if any)
        if: hashFiles('pip-audit-dev.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit-dev.sarif

  tests:
    name: Unit & Security Tests (pytest)
    runs-on: ubuntu-latest
    needs: precommit
    env:
      APP_IMPORT_PATH: app.main:app  # change if your FastAPI app object lives elsewhere
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -r requirements.txt

      - name: Run pytest (quiet)
        run: |
          pytest -q

      - name: Upload pytest cache (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-artifacts
          path: |
            .pytest_cache
            .mypy_cache
          if-no-files-found: ignore

  zap:
    name: OWASP ZAP API DAST
    runs-on: ubuntu-latest
    needs: tests
    timeout-minutes: 30
    env:
      APP_IMPORT_PATH: app.main:app   # change if needed
      HOST: 0.0.0.0
      PORT: 8000
      ZAP_FAIL_ON: "medium"  # 'high' or 'medium' -> pipeline fails if alerts at/above this risk exist
    steps:
      - uses: actions/checkout@v4

      - name: Install runtime deps (to run the app)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Launch FastAPI (background)
        run: |
          nohup bash scripts/start_app.sh > app.log 2>&1 &

      - name: Wait for app
        run: |
          bash scripts/wait-for-http.sh http://127.0.0.1:${PORT}/docs 60

      - name: Run ZAP API scan (docker)
        run: |
          mkdir -p artifacts/zap
          bash scripts/zap-api-scan.sh \
            --target "http://127.0.0.1:${PORT}" \
            --openapi "/openapi.json" \
            --rules ".zap/rules.tsv" \
            --out "artifacts/zap"

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: artifacts/zap
