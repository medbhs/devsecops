name: DevSecOps

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  precommit:
    name: Pre-commit (format, lint, secrets)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements-dev.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          # Install dev tooling; tolerate missing packages to avoid failing if requirements-dev isn't exhaustive
          pip install -r requirements-dev.txt || true
          pip install --upgrade pre-commit black flake8 bandit detect-secrets pip-audit

      - name: Run pre-commit on all files
        run: pre-commit run --all-files

  static:
    name: Static Analysis (Bandit, mypy, pip-audit)
    runs-on: ubuntu-latest
    needs: precommit
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt || true
          pip install -r requirements.txt || true
          pip install --upgrade bandit mypy pip-audit

      - name: Bandit (SARIF)
        run: |
          # produce a SARIF report for Code Scanning UI
          bandit -r . -x tests -f sarif -o bandit.sarif || echo "Bandit finished with exit code (ignored)"

      - name: Upload Bandit SARIF
        if: ${{ always() && (success() || failure()) }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit.sarif

      - name: mypy (type check)
        run: |
          # run mypy across app, but don't hard-fail the job if it returns non-zero; capture output
          mypy --exclude 'tests/' app || echo "mypy completed with warnings/errors"

      - name: pip-audit (requirements*.txt â†’ SARIF)
        run: |
          set -e
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt -f sarif -o pip-audit.sarif || echo "pip-audit completed"
          else
            echo "requirements.txt not found; skipping pip-audit for prod deps"
          fi
          if [ -f requirements-dev.txt ]; then
            pip-audit -r requirements-dev.txt -f sarif -o pip-audit-dev.sarif || echo "pip-audit-dev completed"
          else
            echo "requirements-dev.txt not found; skipping pip-audit for dev deps"
          fi

      - name: Upload pip-audit SARIF (prod)
        if: ${{ always() && (success() || failure()) && (hashFiles('pip-audit.sarif') != '') }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif

      - name: Upload pip-audit SARIF (dev)
        if: ${{ always() && (success() || failure()) && (hashFiles('pip-audit-dev.sarif') != '') }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit-dev.sarif

  tests:
    name: Unit & Security Tests (pytest)
    runs-on: ubuntu-latest
    needs: static
    timeout-minutes: 15
    env:
      APP_IMPORT_PATH: app.main:app
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt || true
          pip install -r requirements.txt || true
          pip install --upgrade pytest httpx

      - name: Run pytest
        run: pytest -q

      - name: Upload pytest caches & artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-artifacts
          path: |
            .pytest_cache
            .mypy_cache
            app.log
          if-no-files-found: ignore

  zap:
    name: OWASP ZAP DAST Scan
    runs-on: ubuntu-latest
    needs: tests
    timeout-minutes: 30
    env:
      APP_IMPORT_PATH: app.main:app
      HOST: 127.0.0.1
      PORT: 8000
      ZAP_FAIL_ON: "medium"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python (for runtime)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install runtime deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install --upgrade uvicorn

      - name: Launch FastAPI (background)
        run: |
          echo "[+] Starting FastAPI app (background)"
          nohup python -m uvicorn ${APP_IMPORT_PATH} --host ${HOST} --port ${PORT} > app.log 2>&1 &
          # give process a short moment to start
          sleep 1

      - name: Wait for app
        # uses your existing script which defaults to /health; here we check docs for readiness
        run: |
          bash scripts/wait-for-http.sh "http://${HOST}:${PORT}/docs" 60

      - name: Run OWASP ZAP Scan
        uses: zaproxy/action-full-scan@v2
        with:
          target: "http://127.0.0.1:${{ env.PORT }}"
          openapi: "/openapi.json"
          fail_on_alert_threshold: ${{ env.ZAP_FAIL_ON }}
          html_report_name: "zap-report.html"

      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-report.html
